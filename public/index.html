// Initialize IndexedDB
let db;
const request = indexedDB.open("FileManagerDB", 1);

request.onupgradeneeded = (e) => {
  db = e.target.result;
  if (!db.objectStoreNames.contains("files")) {
    const store = db.createObjectStore("files", { keyPath: "id", autoIncrement: true });
    store.createIndex("name", "name", { unique: false });
    store.createIndex("type", "type", { unique: false });
  }
};

request.onsuccess = (e) => {
  db = e.target.result;
  displayFiles();
};

request.onerror = (e) => console.error("DB error:", e);

// File Upload
document.getElementById("fileInput").addEventListener("change", (e) => {
  const files = Array.from(e.target.files);
  const tx = db.transaction("files", "readwrite");
  const store = tx.objectStore("files");

  files.forEach(file => {
    const reader = new FileReader();
    reader.onload = function(evt) {
      store.add({
        name: file.name,
        type: getFileType(file),
        data: evt.target.result,
        size: file.size,
        date: new Date().toISOString()
      });
      tx.oncomplete = () => displayFiles();
    };
    reader.readAsDataURL(file);
  });
  e.target.value = "";
});

// Helpers
function getFileType(file) {
  if (file.type.startsWith("image/")) return "image";
  if (file.name.endsWith(".xlsx") || file.name.endsWith(".csv")) return "excel";
  if (file.type === "application/pdf") return "pdf";
  return "other";
}

// Display Files
function displayFiles() {
  const fileList = document.getElementById("fileList");
  fileList.innerHTML = "";

  const searchTerm = document.getElementById("searchInput").value.toLowerCase();
  const filterType = document.getElementById("filterSelect").value;

  const tx = db.transaction("files", "readonly");
  const store = tx.objectStore("files");
  const requestAll = store.getAll();

  requestAll.onsuccess = () => {
    let files = requestAll.result;

    if (searchTerm) {
      files = files.filter(f => f.name.toLowerCase().includes(searchTerm));
    }
    if (filterType !== "all") {
      files = files.filter(f => f.type === filterType);
    }

    files.forEach(file => {
      const div = document.createElement("div");
      div.className = "bg-white p-3 rounded shadow flex flex-col items-start";

      const title = document.createElement("div");
      title.className = "font-medium mb-2";
      title.textContent = file.name;

      // Preview
      let preview;
      if (file.type === "image") {
        preview = document.createElement("img");
        preview.src = file.data;
        preview.className = "w-full h-32 object-contain mb-2";
      } else if (file.type === "excel") {
        preview = document.createElement("div");
        preview.className = "text-sm text-gray-600 mb-2";
        preview.textContent = "Excel file (click view)";
      } else if (file.type === "pdf") {
        preview = document.createElement("div");
        preview.className = "text-sm text-gray-600 mb-2";
        preview.textContent = "PDF file";
      }

      // Buttons
      const btnContainer = document.createElement("div");
      btnContainer.className = "flex gap-2";

      const downloadBtn = document.createElement("button");
      downloadBtn.textContent = "Download";
      downloadBtn.className = "bg-blue-500 text-white px-2 py-1 rounded text-sm";
      downloadBtn.onclick = () => downloadFile(file);

      const deleteBtn = document.createElement("button");
      deleteBtn.textContent = "Delete";
      deleteBtn.className = "bg-red-500 text-white px-2 py-1 rounded text-sm";
      deleteBtn.onclick = () => deleteFile(file.id);

      const viewBtn = document.createElement("button");
      viewBtn.textContent = "View";
      viewBtn.className = "bg-green-500 text-white px-2 py-1 rounded text-sm";
      viewBtn.onclick = () => viewFile(file);

      btnContainer.append(downloadBtn, deleteBtn, viewBtn);
      div.append(title, preview, btnContainer);
      fileList.appendChild(div);
    });
  };
}

// File Actions
function downloadFile(file) {
  const a = document.createElement("a");
  a.href = file.data;
  a.download = file.name;
  a.click();
}

function deleteFile(id) {
  const tx = db.transaction("files", "readwrite");
  const store = tx.objectStore("files");
  store.delete(id);
  tx.oncomplete = () => displayFiles();
}

function viewFile(file) {
  if (file.type === "excel") {
    const wb = XLSX.read(file.data, { type: "base64" });
    const wsname = wb.SheetNames[0];
    const ws = wb.Sheets[wsname];
    const data = XLSX.utils.sheet_to_json(ws, { header: 1 });
    alert("First 10 rows:\n" + data.slice(0, 10).map(r => r.join(" | ")).join("\n"));
  } else if (file.type === "pdf") {
    const win = window.open("");
    win.document.write(`<embed src="${file.data}" width="100%" height="100%">`);
  } else if (file.type === "image") {
    const win = window.open("");
    win.document.write(`<img src="${file.data}" style="width:100%">`);
  }
}

// Search & Filter Events
document.getElementById("searchInput").addEventListener("input", displayFiles);
document.getElementById("filterSelect").addEventListener("change", displayFiles);
