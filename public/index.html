<script>
  // ======== CONFIG ========
  const qs = new URLSearchParams(location.search);
  const fromQuery = qs.get('api');
  const savedBase = localStorage.getItem('DASHBOARD_BASE_URL');
  const BASE_URL = (fromQuery || savedBase || (location.protocol.startsWith('http') ? location.origin : '')).replace(/\/$/, '');
  const RANGE = () => document.getElementById('rangeSelect').value || '7d';
  const REFRESH_MS = 10000; // 10s

  const isFile = location.protocol === 'file:';

  // ======== DEMO DATA ========
  const DEMO = {
    metrics: { reach: 1200000, engagement: 450000, campaigns: 12, leads: 320, ts: new Date().toISOString() },
    posts: [
      { id: 'P001', platform: 'Facebook', engagement: 2100 },
      { id: 'P002', platform: 'Instagram', engagement: 3500 },
      { id: 'P003', platform: 'YouTube', engagement: 1800 },
    ],
    events: [
      { date: '2025-08-25', event: 'Campaign Launch', location: 'Bengaluru' },
      { date: '2025-08-30', event: 'Youth Meetup', location: 'Vijayapura' },
    ],
    trend: {
      '7d': { labels: ['Mon','Tue','Wed','Thu','Fri','Sat','Sun'], data: [12,19,7,11,14,20,9] },
      '30d': { labels: Array.from({length:30}, (_,i)=>`D${i+1}`), data: Array.from({length:30}, ()=>Math.floor(10+Math.random()*20)) },
      '12w': { labels: Array.from({length:12}, (_,i)=>`W${i+1}`), data: Array.from({length:12}, ()=>Math.floor(80+Math.random()*120)) },
    }
  };

  // ======== UTILITIES ========
  function cacheSet(key, value) { localStorage.setItem(key, JSON.stringify({ value, ts: Date.now() })); }
  function cacheGet(key, maxAgeMs) {
    try {
      const raw = localStorage.getItem(key); if (!raw) return null;
      const { value, ts } = JSON.parse(raw);
      if (maxAgeMs && Date.now() - ts > maxAgeMs) return null;
      return value;
    } catch { return null; }
  }

  function timeoutFetch(resource, options = {}) {
    const { timeout = 8000 } = options;
    const controller = new AbortController();
    const id = setTimeout(() => controller.abort(), timeout);
    return fetch(resource, { ...options, signal: controller.signal })
      .finally(() => clearTimeout(id));
  }

  async function fetchJSON(url) {
    const res = await timeoutFetch(url, { headers: { 'Accept': 'application/json' }, timeout: 8000 });
    if (!res.ok) throw new Error(`HTTP ${res.status} for ${url}`);
    return res.json();
  }

  const fmt = new Intl.NumberFormat('en', { notation: 'compact' });

  // ======== CHART ========
  let chart;
  function renderChart(trend) {
    const ctx = document.getElementById('engagementChart').getContext('2d');
    if (chart) chart.destroy();
    chart = new Chart(ctx, {
      type: 'line',
      data: {
        labels: trend.labels,
        datasets: [{
          label: 'Engagement',
          data: trend.data,
          borderColor: '#2563eb',
          backgroundColor: 'rgba(37,99,235,0.2)',
          fill: true,
          tension: 0.3,
          pointRadius: 2
        }]
      },
      options: { responsive: true, maintainAspectRatio: true }
    });
  }

  // ======== RENDER FUNCTIONS ========
  function renderMetrics(m) {
    document.getElementById('reach').textContent = typeof m.reach === 'number' ? fmt.format(m.reach) : m.reach;
    document.getElementById('engagement').textContent = typeof m.engagement === 'number' ? fmt.format(m.engagement) : m.engagement;
    document.getElementById('campaigns').textContent = m.campaigns;
    document.getElementById('leads').textContent = m.leads;
    const ts = m.ts ? new Date(m.ts) : new Date();
    const when = ts.toLocaleString();
    ['reachSub','engagementSub','campaignsSub','leadsSub'].forEach(id => document.getElementById(id).textContent = `Last updated ${when}`);
  }

  function renderPosts(list) {
    const q = (document.getElementById('postSearch').value || '').toLowerCase();
    const body = document.querySelector('#top-posts tbody');
    body.innerHTML = '';
    list.filter(p => !q || `${p.id} ${p.platform}`.toLowerCase().includes(q))
        .forEach(p => body.insertAdjacentHTML('beforeend', `
          <tr class="border-t">
            <td class="p-3">${p.id}</td>
            <td class="p-3">${p.platform}</td>
            <td class="p-3">${fmt.format(p.engagement)}</td>
          </tr>`));
  }

  function renderEvents(rows) {
    const body = document.querySelector('#events tbody');
    body.innerHTML = '';
    rows.slice().sort((a,b) => new Date(a.date) - new Date(b.date))
        .forEach(e => {
          const d = new Date(e.date);
          body.insertAdjacentHTML('beforeend', `
            <tr class="border-t">
              <td class="p-3">${isNaN(d) ? e.date : d.toLocaleDateString()}</td>
              <td class="p-3">${e.event}</td>
              <td class="p-3">${e.location}</td>
            </tr>`);
        });
  }

  // ======== FETCH LOOP ========
  let isFetching = false;
  async function fetchData() {
    if (isFetching) return;
    isFetching = true;
    const useDemo = isFile || !BASE_URL || BASE_URL === 'null' || BASE_URL === 'undefined';

    let metrics, posts, events, trend;

    try {
      if (useDemo) {
        metrics = DEMO.metrics;
        posts = DEMO.posts;
        events = DEMO.events;
        trend = DEMO.trend[RANGE()];
      } else {
        const [mRes, pRes, eRes, tRes] = await Promise.allSettled([
          fetchJSON(`${BASE_URL}/api/metrics`),
          fetchJSON(`${BASE_URL}/api/posts`),
          fetchJSON(`${BASE_URL}/api/events`),
          fetchJSON(`${BASE_URL}/api/engagement-trend?range=${encodeURIComponent(RANGE())}`)
        ]);

        metrics = mRes.status === 'fulfilled' ? mRes.value : cacheGet('metrics', 15*60*1000) || DEMO.metrics;
        posts = pRes.status === 'fulfilled' ? pRes.value : cacheGet('posts', 15*60*1000) || DEMO.posts;
        events = eRes.status === 'fulfilled' ? eRes.value : cacheGet('events', 15*60*1000) || DEMO.events;
        trend = tRes.status === 'fulfilled' ? tRes.value : cacheGet('trend', 15*60*1000)?.[RANGE()] || DEMO.trend[RANGE()];
      }

      renderMetrics(metrics);
      renderPosts(posts);
      renderEvents(events);
      renderChart(trend);

    } catch(err) {
      console.error('Error loading data:', err);
      // fallback silently to demo data
      renderMetrics(DEMO.metrics);
      renderPosts(DEMO.posts);
      renderEvents(DEMO.events);
      renderChart(DEMO.trend[RANGE()]);
    } finally {
      isFetching = false;
    }
  }

  document.getElementById('refreshBtn').addEventListener('click', fetchData);
  document.getElementById('rangeSelect').addEventListener('change', fetchData);
  document.getElementById('postSearch').addEventListener('input', () => renderPosts(cacheGet('posts', 5*60*1000) || DEMO.posts));

  // Auto-refresh
  const REFRESH_SECS = REFRESH_MS/1000;
  let left = REFRESH_SECS;
  setInterval(() => { left--; if(left<0){ left=REFRESH_SECS; fetchData(); } document.getElementById('refreshLabel').textContent=`Auto refresh: ${left}s`; }, 1000);

  // Dev Panel Buttons
  document.getElementById('saveApiBtn')?.addEventListener('click', () => {
    const val = document.getElementById('apiBaseInput').value.trim();
    localStorage.setItem('DASHBOARD_BASE_URL', val);
    location.href = location.pathname + '?dev=1';
  });
  document.getElementById('clearCacheBtn')?.addEventListener('click', ()
